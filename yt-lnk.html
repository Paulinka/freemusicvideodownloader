<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>YouTube Links</title>
    <!-- for core -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdn.rawgit.com/jquery/esprima/2.2.0/esprima.js"></script>
    <script src="https://cdn.rawgit.com/estools/escodegen/1.6.1/escodegen.browser.min.js"></script>
    <script src="yt-lnk.js"></script>
    <!-- for ui -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <style type="text/css">
        .col-centered {
            margin: 0 auto;
            float: none;
        }

        .top-spacer-10 {
            margin-top: 10px;
        }

        .result-box {
            height: 290px;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div id="main_title" class="row">
        <div class="col-xs-4 col-centered"><h1 class="text-center">YouTube Links</h1></div>
    </div>
    <div id="main_search" class="row top-spacer-10">
        <div class="col-xs-4 col-centered">
            <div class="input-group">
                <input id="txt_keywords" type="text" class="form-control"
                       placeholder="Search for ... or YouTube video link"/>
                <span class="input-group-btn">
                    <button id="btn_search" class="btn btn-default" type="button">Search</button>
                </span>
            </div>
            <br/>
            <small><a href="https://github.com/aldenml/yt-lnk">Fork me</a></small>
        </div>
    </div>
    <div id="main_results" class="row">
        <div class="col-xs-8 col-centered">
            <div id="tbl_results"></div>
        </div>
    </div>
    <div id="main_links" class="row">
        <div class="col-xs-4 col-centered">
            <table id="tbl_result" class="table">
            </table>
        </div>
    </div>
</div>
<script type="application/javascript">

    function submitSearch(keywords) {
        var btn = $('#btn_search');
        var tbl = $('#tbl_results');
        if (btn.prop('disabled')) {
            return; //busy
        }

        $('#main_results').show();
        $('#main_links').hide();

        btn.prop('disabled', true);
        btn.text('Searching...');

        tbl.empty();

        search(keywords).done(function (results) {
            btn.prop('disabled', false);
            btn.text('Search');

            log(results);

            $.each(results, function (i, r) {
                var thumbnail = '<img class="img-responsive" src="' + r.thumbnail + '" alt="' + r.title + '"/>';
                var title = '<strong><a target="_blank" href="' + r.url + '">' + r.title + '</a></strong>';
                var duration = ' - ' + r.duration;
                var by = '<div class="small">by <a target="_blank" href="https://www.youtube.com/user/' + r.user + '">' + r.user + '</a></div>';
                var views = '<div class="small">' + r.views.toLocaleString() + ' views</div>';
                var btn = '<button class="btn btn-default" type="button" onclick="submitLinks(\'' + r.url + '\')">Get Links</button>';
                var html = thumbnail + title + duration + by + views + btn;
                $('<div>').prop('class', 'col-xs-12 col-md-4 result-box').html(html).appendTo(tbl);
            });
        });
    }

    function submitLinks(url) {
        var btn = $('#btn_search');
        var tbl = $('#tbl_result');
        if (btn.prop('disabled')) {
            return; //busy
        }

        $('#main_results').hide();
        $('#main_links').show();

        $('#txt_keywords').val(url);

        btn.prop('disabled', true);
        btn.text('Wait...');

        tbl.empty()

        extract(url).done(function (result) {
            log(result);

            btn.prop('disabled', false);
            btn.text('Search');

            $('<tr>').html('<td colspan="3">Title: ' + result.title + '</td>').appendTo('#tbl_result');
            $('<tr>').html('<td colspan="3">Note: Right click for save as </td>').appendTo('#tbl_result');

            $('<tr>').html("<td></td><td>Open</td><td>Type</td><td>Extra</td>").appendTo('#tbl_result');

            $.each(result.formats, function (i, fmt) {
                var lnk = '<a target="_blank" href="' + fmt.url + '" download>Link</a>';
                var vlcLnk = '<a href="vlc://' + fmt.url + '">VLC</a>';
                var ext = fmt.ext;

                var extra = (fmt.abr ? (fmt.abr + 'k') : '') + (fmt.height ? (fmt.height + 'p') : '') + ' ' + (fmt.format_note ? fmt.format_note : '');
                if (fmt.format_note && fmt.format_note.indexOf('DASH video') != -1) {
                    extra = extra + ' (no audio)';
                }

                $('<tr>').html("<td>" + lnk + "</td><td>" + vlcLnk + "</td><td>" + ext + "</td><td>" + extra + "</td>").appendTo('#tbl_result');
            });

            if (result.subtitles !== null) {
                $.each(result.subtitles, function (i, lang) {
                    $.each(lang, function (j, fmt) {
                        var lnk = '<a target="_blank" href="' + fmt.url + '" download>Link</a>';
                        var vlcLnk = '<a href="vlc://' + fmt.url + '">VLC</a>';
                        var ext = fmt.ext;

                        var extra = i + ' Subtitle';

                        $('<tr>').html("<td>" + lnk + "</td><td>" + vlcLnk + ext + "</td><td>" + extra + "</td>").appendTo('#tbl_result');
                    });
                });
            }

            if (result.dash_manifest_url !== null) {
                var lnk = '<a target="_blank" href="' + result.dash_manifest_url + '" download>Link</a>';
                var ext = 'mpd';

                var extra = 'DASH manifest';

                $('<tr>').html("<td>" + lnk + "</td><td>" + ext + "</td><td>" + extra + "</td>").appendTo('#tbl_result');
            }
        });
    }

    function doSearch() {
        var s = $('#txt_keywords').val().trim();
        var videoId = extractId(s);

        if (videoId === null) {
            submitSearch(s);
        } else {
            submitLinks(s);
        }
    }

    $('#txt_keywords').bind("keydown", function (event) {
        if (event.keyCode === $.ui.keyCode.ENTER) {
            doSearch();
            $('#txt_keywords').autocomplete("close");
        }
    }).autocomplete({
        minLength: 2,
        source: ytAutocompleteSource,
        select: function (event, ui) {
            $('#txt_keywords').val(ui.item.value);
            $('#btn_search').click();
        }
    });

    $('#btn_search').click(doSearch);

    submitSearch('');
</script>
</body>
</html>
